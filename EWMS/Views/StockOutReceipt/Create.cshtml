@model EWMS.ViewModels.SalesOrderForStockOutViewModel
@{
    ViewData["Title"] = "Create Stock Out Receipt";
}

@section Styles {
    <link rel="stylesheet" href="~/css/stockoutreceipt.css" asp-append-version="true" />
}

<div class="page-header">
    <div>
        <h1>Create Stock Out Receipt</h1>
        <p>Order: <strong>@Model.OrderNumber</strong></p>
    </div>
    <div>
        <a href="@Url.Action("Index")" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card">
    <div class="card-body">
        <form asp-action="Create" method="post" id="createReceiptForm">
            <input type="hidden" name="SalesOrderId" value="@Model.SalesOrderId" />
            <input type="hidden" name="WarehouseId" value="@ViewBag.WarehouseId" />
            <input type="hidden" name="Reason" value="Sale" />

            <div class="detail-section">
                <h4>Order Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Order ID:</div>
                        <div class="detail-value"><strong>@Model.OrderNumber</strong></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Customer:</div>
                        <div class="detail-value">@Model.CustomerName</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Expected Delivery:</div>
                        <div class="detail-value">@Model.ExpectedDeliveryDate.ToString("dd/MM/yyyy")</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Total Amount:</div>
                        <div class="detail-value"><strong>@Model.TotalAmount.ToString("N0") đ</strong></div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Notes))
                    {
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label">Notes:</div>
                            <div class="detail-value">@Model.Notes</div>
                        </div>
                    }
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="IssuedDate" class="form-label">Actual Issue Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="IssuedDate" name="IssuedDate" 
                               value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Warehouse</label>
                        <input type="text" class="form-control" value="@ViewBag.WarehouseName" readonly />
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h4>Select Stock Out Location</h4>
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle"></i> Select Pickup Location for each product in the order
                </p>

                <div id="locationLines">
                    @for (int i = 0; i < Model.Details.Count; i++)
                    {
                        var detail = Model.Details[i];
                        <div class="location-line mb-3" id="location-line-@i">
                            <input type="hidden" name="Details[@i].ProductId" value="@detail.ProductId" />
                            <input type="hidden" name="Details[@i].UnitPrice" value="@detail.UnitPrice" />
                            
                            <div class="row align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Product</label>
                                    <input type="text" class="form-control" value="@detail.ProductName" readonly />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantity to Ship</label>
                                    <input type="number" class="form-control ship-qty" name="Details[@i].Quantity" value="@detail.Quantity" min="1" max="@detail.Quantity" data-required="@detail.Quantity" required oninput="updateInventoryStatus()" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Pickup Location <span class="text-danger">*</span></label>
                                    <select class="form-select location-select" 
                                            name="Details[@i].LocationId"
                                            data-product-id="@detail.ProductId" 
                                            data-quantity="@detail.Quantity"
                                            data-index="@i"
                                            required
                                            onchange="updateInventoryStatus()">
                                        <option value="">-- Select location --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="inventory-status mb-4">
                <h5><i class="bi bi-box-seam"></i> Inventory Status</h5>
                <div id="inventoryStatus" class="mt-3">
                    <p class="text-muted">Select location to view inventory status</p>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <a href="@Url.Action("Index")" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
                <button type="submit" class="btn btn-success" id="submitBtn">
                    <i class="bi bi-check-circle"></i> Create Stock Out Receipt
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const warehouseId = @ViewBag.WarehouseId;
        const productLocations = {};

        async function loadAvailableLocations() {
            const selects = document.querySelectorAll('.location-select');
            
            for (const select of selects) {
                const productId = select.getAttribute('data-product-id');
                
                try {
                    const response = await fetch(`/StockOutReceipt/GetAvailableLocations?warehouseId=${warehouseId}&productId=${productId}`);
                    const locations = await response.json();
                    
                    productLocations[productId] = locations;
                    
                    locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.locationId;
                        option.textContent = `${loc.locationCode} (Existing: ${loc.availableQuantity})`;
                        option.setAttribute('data-available', loc.availableQuantity);
                        option.setAttribute('data-location-name', loc.locationName || '');
                        select.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('Error loading locations:', error);
                }
            }
        }

        function updateInventoryStatus() {
            const container = document.getElementById('inventoryStatus');
            const selects = document.querySelectorAll('.location-select');
            
            let statusHTML = '';
            let allValid = true;
            let allSelected = true;

            selects.forEach(select => {
                const productId = select.getAttribute('data-product-id');
                const qtyInput = select.closest('.location-line').querySelector('.ship-qty');
                const requiredQty = parseInt(qtyInput?.value || select.getAttribute('data-quantity'));
                const selectedOption = select.options[select.selectedIndex];
                const locationId = select.value;
                const productName = select.closest('.location-line').querySelector('input[readonly]').value;

                if (locationId) {
                    const available = parseInt(selectedOption.getAttribute('data-available'));
                    const isValid = available >= requiredQty;

                    if (!isValid) allValid = false;

                    const statusClass = isValid ? 'text-success' : 'text-danger';
                    const icon = isValid ? 'check-circle-fill' : 'x-circle-fill';

                    statusHTML += `
                        <div class="inventory-item">
                            <div>
                                <strong>${productName}</strong><br>
                                <small class="text-muted">Vị trí: ${selectedOption.text}</small>
                            </div>
                            <div class="text-end ${statusClass} fw-bold">
                                <i class="bi bi-${icon}"></i> ${available} Existing / ${requiredQty} need
                            </div>
                        </div>
                    `;
                } else {
                    allSelected = false;
                    statusHTML += `
                        <div class="inventory-item">
                            <div>
                                <strong>${productName}</strong><br>
                                <small class="text-warning">Location not yet selected</small>
                            </div>
                            <div class="text-end text-warning">
                                Need: ${requiredQty}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = statusHTML || '<p class="text-muted">Select location to view inventory status</p>';

            const submitBtn = document.getElementById('submitBtn');
            if (allSelected && allValid) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-secondary');
                submitBtn.classList.add('btn-success');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-secondary');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableLocations();
            updateInventoryStatus();
        });

        document.getElementById('createReceiptForm').addEventListener('submit', (e) => {
            const selects = document.querySelectorAll('.location-select');
            let hasError = false;

            selects.forEach(select => {
                if (!select.value) {
                    hasError = true;
                }
            });

            if (hasError) {
                e.preventDefault();
                alert('Please select Pickup Location for all products!');
                return false;
            }
        });
    </script>
}
